---
title: "Simulate Model 1 Data"
author: "Bethan Cracknell Daniels"
date: "30/05/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Hi and welcome to the first SARS-CoV-2 model in this exampler. The overall aim of this script is to fit a Susceptible (S) - Exposed (E) - Infectious (I) - Quarantine (Q) - Recovered (R) model to real incidence and genomic data collected in Gauteng, South Africa between late 2021 and early 2022. 


Hopefully, this project will show how we design an infectious disease compartmental model to answer a public health questions. There are many choices to be made along the way so it is important to think about the assumptions we are making so our model is robust. 

Some questions include:

- what are the most important disease and epi features?
- how do we represent these features in a model?
- what data do I need?
- what parameters shoud I estiamte? 

As well as desiging a model, we will also simulate fake data to check our model works, explore different methods of solving ordinary differential equations (ODEs) in Stan, check our Stan model is fitting well and produce some nice epi curves! 

This code also aims to be reusable, sustainable and testable - important features often overlooked in R! 


But first, 

# Designing our model

**Disclaimer: "all models are wrong. Some models are useful" - George E. P. Box**


First, lets take a look at the storyboard below. It outlines what I think are all they key steps when designing and building a model logically. 

Briefly, we need to define our research question (1), population and time period (2). Then we need to think about what data we will fit our model to (3). Incidence data? Prevalance data?

Next, building the compartmental model (4). Compartmental modelsare the bread and butter of infectious disease modelling. They are a simple system of differential equations whcih describe the movement of individuals from one state to another. In the figure we show an SIR model, the most simple model typically used. Individuals in a population start out susceptible to a disease, they have no prior exposure to the disease and so no protective immunity. This is the S compartment. From there, individuals may be exposed and infected by the pathogen, at which point they enter the I compartment. Finally, they recover from the disease and are no longer infectious, they enter the R compartment. 

I will assume you are familiar with compartmental models and so won't go into further detail here. If you are not so familiar, there are lots of good resources out there which already explain SIR models. 

For instance, Imperial has a module on SIR modules on [Coursera](https://www.coursera.org/lecture/developing-the-sir-model/introduction-to-the-sir-model-FXISd?redirectTo=%2Flearn%2Fdeveloping-the-sir-model%3Faction%3Denroll)

Or there are an abundance of videos on YouTube where people introduce SIR models, especially since COVID-19... [This](https://www.youtube.com/watch?v=Qrp40ck3WpI) is a nice intro! 

Having designed the model, we need to think about the intial conditions for each state (5). If an infectious agent is entirely new to a population, like SARS-CoV-2 was at the start of 2020, we would expect all of the population to be in the S compartment, with a few individuals in the infectious compartment: $S = N - I_0$. If the in pathogen is not novel, then we might expect some of the population to be in the recovered compartment. Critically, the sum of all the compartments must equal the population, $S + I + R = N$. 

The flow between the compartments is governed by rates (6). In this example, we have the transmission rate, typically denoted $\beta$ and the recovery rate, $\gamma$. Note that because transmission depends on the number of infectious people we need to account for this. Hence, the force of infection (the per capita rate that susceptible indviduals contract the infection) depends on the prevalance of infectious people  and the transmission rate:

$\lambda = \frac{I}{N} \beta$

Next, converting our model diagram into ODE equations (7). Simply, arrows leading out of a compartment are subtraction and arrows leading into a compartment are addition. 

After that, we need to decide which parameters we want to fix (8) and which we want to estimate (9). This likely depends on the research question and available literature.

As we conducting Bayesian modelling, the next decisions we need to make are about the priors (10) and likelihood (11). Hopefully you are familiar with Bayesian statistics, but if not then I recommend going back to some of the resources suggested at the top, namely A students guide to Bayesian Statistics! 

Briefly, what we are asking is, given the data $y$, what are the most likely parameters $\theta$. *Note, when we talk of parameters here, this refers to those we are estimating, not the fixed parameters*. 

In other words, our posterior is $Pr(\theta|y)$. Bayes rule tells us that:

$$
Pr(\theta | y) \propto Pr(y | \theta) Pr(\theta)
$$
Where, $Pr(y | \theta)$ is the likelihood, or sampling distribution, and $Pr(\theta)$ are our priors. The likelihood tells us how to generate our data $y$, given our model parameters. Our priors allow us to incorporate existing domain knowledge into the model. 

Generally, we want priors to be vague enough to explore all reaonsable parameter values whilst preventing the sampler exploring areas of posterior space that are implausible. For instance, say we were to estimate the recovery rate, $\gamma$. $\gamma = \frac{1}{D}$, where $D$ is the duration of infection. We know that this must be a postive number, so we can relfect that in our prior. Moreover, even if we did not know very much about the clinical progression of COVID-19, we know that is an acute infection, not a chronic infection - i.e., people generally recovery within days - weeks. So we would want to explore recovery rates that reflect thus. Allowing the sampler to explore the posterior distribution where $\frac{1}{\gamma}$ is hundreds or even thousands of days is inefficient.

We also need to think about the model likelihood, our data generating process. Essentially, we need to link our model output to the observed data we are fitting to. The distribution we choose to link our model out will depend on the type of data we have, and there often isn't only one choice. 

In infectious disease modelling we often have incidence data (i.e., count data) which we fit using a [Poisson likelihood](https://www.youtube.com/watch?v=H20k1O1zvik&list=PLwJRxp3blEvZ8AKMXOy0fc0cqT61GsKCG&index=27). The Poisson distribution has one parameter, $\lambda$ which is the mean rate of events (i.e. infections) occurring in a fixed time or place. $\lambda$ is both the mean and variance of the Poisson distribution. 

**Question: If we were to use the Poisson distribution to fit to incidence data, what model output would we fit to?**

Alternatively, if we think the data is over-dispersed, that is if we think that the number of secondary infections may vary a lot between individuals or settings then we might want to use a Negative Binomial likelihood. The Negative Binomial distribution extends the Poisson distribution with an additional parameter $\kappa$ which controls the overdispersion of the distribution. Critically, the variance is now $> \lambda$, whereas the Poisson distribution assumes that the variance $= \lambda$. When $\kappa$ is very small, overdispersion is high, but when $\kappa$ is large enough, the Negative Binomial distribution converges on the Poisson! 


The final step in building our model is to think about the assumptions we have made along the way. As we said before, no model is perfect. We want our model to be as simple as possible, whilst still capturing the important features of the pathogen. This means we have to make simplifying assumptions in how we represent the transmission process in our compartments. One notable assumption is that everyone in the compartments in homogeneous. Equally, there might be lots of unknowns about the disease or the data, which again means we will have to make assumptions! We can also do sensitivity analyses to explore the impact of our assumptions. 

![Designing a compartmental model.](images/Generic modelling storyboard.png)

An important thing to note is that although these may seem like a linear set of steps to building a model, model fitting is far from a linear process! These steps provide a loose guidance for the first iteration of model building, which should be as simple as possible. It is important to be flexible with these steps and to expect to have to go back and make changes to the model once you start fitting to the data. It may be that you realise you need additional data (3), you realise one of your simplifying assumptions (12) doesn't allow you to capture a key aspect of the data and so you ammend the model by introducing extra compartments (4). Maybe there is more data avialable than when you started so you change a fixed parameter value (8) or ammend your priors to incorporate additional domain knowledge (10)... you get the idea! 

So, now lets design the model! 

#### Step 1: Define the reseach question

![Step 1.](images/1.png)

### Step 2: What is the population and time period?

This is partly answered by the research question, we are interested in the population of Gauteng and the period of time when Omicron first emerged.The population of Gauteng is 15,810,388.

We know that Omicron was first deteced in October 2021, but we suspect that there was probably some transmission before it was detected, so the start of our modelling period will be September 2021. 

We want to explore the dynamics during the 4th Omicron driven wave. If you look at [this](https://covid19.who.int/region/afro/country/za) dashboard provided by the WHO, we can see that the 4th wave was over by ~Febuary. We will run our model till the 23rd of February to make sure we capture all of the epidemic curve. 


![Step 2](images/2.png)
### Step 3: What data are we fitting the model to?

We are going to fit to the *reported* incidence of SARS-CoV-2. 

![Step 3](images/3.png)


### Step 4: What compartments do we minimally need to represent the disease transmission process? 

Starting with the SIR model, we want to account for the [incubtion period](https://en.wikipedia.org/wiki/Incubation_period) of COVID-19 and we need to account for only having data on the reported incidence. Therefore, we want to extend the model in some way which allows for individuals to either be detected, reported and isolated or not detected, in which case they carry on as normal and are infectious. 


**Activity: draw out a compartmental model which accounts for the above**




















**Solution:**

![Step 4](images/4.png)


### Step 5: What are the initial conditions? What do we want to estimate? What do we want to fix?

Our population = $N$ = 15810388.

We can assume that $E_0$ and $Q_0$ = 0. 

As we are fitting to the 4th wave of SARS-CoV-2 in Gauteng, we know some of the population will already have had an infection and have immunity, so they go in the $R$ compartment. We can look to seroprevalance surveys for data on the percentage of the population with immunity.56.2% of the unvaccinated population of Gauteng had antibodies to SARS-CoV-2 in December 2021 [1]. Note, this is slightly after the emergence of Omicron but it is the best data we have for now. 

So $R_0 = 15,810,388 . 0.562 = 8,885,438$

We don't know how many initial infections where were or exactly what time period Omicron emerged, so we will estiamte $I_0$. 

Finally, $S_0 = N - R_0 - I_0$ 

![Step 5](images/5.png)

### Step 6: What are the rate parameters which describe movement  between the compartments?


![Step 6](images/6.png)
Note, $\beta$, $\sigma$ and $\gamma$ are all per capita rates, whereas $\rho$ is a probability. All individuals will progress to be infectious at an average rate of $\sigma$ and some % will be tested and reported $= \rho $.



### Step 7: What are the equations that govern the model?

![Step 7](images/7.png)

Once you have a flow diagram with rates, writing the equations is simple! Arrows out of a state are subtracted, arrows into a stated are added. A good check is to make sure the equations balance. 

### Step 8: Which parameters can we fix based on the literature?


![Step 8](images/8.png)

The incubation and infectious period are well defined for previous SARS-CoV-2 variants, and we will assume (at least for now) that they are the same for the new Omicron variant. We therefore assume an average incubation period $1/σ$ of 5.1 days [2] and an average infectious period $1/γ$ of 2.1 days [3]. 

### Step 9: Which parameters do we need to estimate?

By process of elimination, we are going to estiamte $\beta$ and $\rho$. 

**Activity: why would we want to estimate these parameters?**










**Solution**

![Step 9](images/9.png)

### Step 10: Do we have any domain knowledge to inform the parameter priors?

First, $\rho$, the probability of reporting. $\rho$ must be between 0 and 1, so a [beta](https://en.wikipedia.org/wiki/Beta_distribution) prior is suitable here. For  now, lets assume that any probability of reporting is equally likely and say that $\rho \sim Beta(1,1)$. 


**Activity: use the function `rbeta()` to check that $\rho \sim Beta(1,1)$ provides a uniform distribution between 0 and 1.** 


For $\beta$ we are not sure how transmissible Omicron is yet,  but we think somewhere similar or more transmissible than the Delta variant. A useful measure of transmission is the [Reproduction number](https://en.wikipedia.org/wiki/Basic_reproduction_number) ($R_0$), the average number of secondary cases produced per infectious individual in an susceptible population. 

The $R_0$ is equal to the rate that individuals are infectious / the rate they recover. For a simple SIR model this would be $R_0 = \frac{\beta}{\gamma}$. For our model $R_0 = \frac{(1-\rho)\beta}{\gamma}$. This can be confirmed using the [next generation matrices method], if interested. (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2871801/#:~:text=The%20basic%20reproduction%20number%20%E2%84%9B,categories%20of%20individuals%20are%20recognized). 


The $R_0$ of Delta is estiamted around 5 [4], so exploring values of $\beta$ that correspond to an $R_0$ of 5 and higher seems reasonable.


**Activity: Come up with a prior for $\beta$ which supports $\R_0$ ranging from 1 - ~12, given $\rho$ values ranging from 0-1.**












**Solution**


$\beta = \frac{R_0 \gamma}{(1-\rho)}$. 

```{r}
R0 = runif(10000,2,12) # draw randomly 10,000 values between 2 and 12 
gamma = 1/5.1
rho = runif(10000,0,1) 

# calculate values of beta 
beta = R0 * gamma / (1-rho) 
 
# 95% quantiles of beta 
quantile(beta, probs = c(0.025,0.975)) 

# draw from a log normal distribution 
beta_prior = rlnorm(10000,0.8,0.5)

# check values of beta support R0 range 
R0_p = (1-rho) * (beta_prior) / gamma

quantile(R0_p,  probs = c(0.025,0.1,0.25, 0.5, 0.75,0.9,0.975))

plot(density(R0_p))
```

We can see that $\beta \sim Lognormal(0.8,0.5)$ supports $\R0$ values mostly between 1 and 13, but allow for extreme values of $\R0$ if the data supports it. 


Finally, we will assume that Omicron was seeded by very few individuals given Gauteng: $I_0 \sim Normal(1,5)$. Note, that although this allows for negative values, we can set parameter bounds in Stan which will ensure the seed is positive. 


![Step 10](images/10.png)


### Step 11: What is the model likelihood?

SARS-CoV-2 is known to be overdispersed, so we will use a Negative-Binomial likelihood. We will match the reported incidence data to the reported incidence in our model, which is the rate of entry into the $Q$ compartment.

Thus, let  $\lambda = \rho \sigma E$. Our likelihood is therefore 

$$ y \sim NegBin(\lambda, \kappa) $$


This means we need to additionally estimate $\kappa$. We will assume  for which we will assume the prior $\kappa \sim exp(0.01)$ which allows for a wide range of values relfecting our uncertainty. 

![Step 11](images/11.png)

### Step 12: What assumptions have we made?

These are just some of the assumptions, there are plenty more to think about!

![Step 12](images/12.png)


Now we have designed our first infectious disease model, we can get onto coding it! 

# Stan 

If you aren't familiar with Stan I recommend watching [this](https://www.youtube.com/watch?v=YZZSYIx1-mw&list=PLwJRxp3blEvZ8AKMXOy0fc0cqT61GsKCG&index=72) and [this](https://www.youtube.com/watch?v=a-wydhEuAm0&list=PLwJRxp3blEvZ8AKMXOy0fc0cqT61GsKCG&index=69) for an introduction into coding a Stan model and the Hamiltonian Monte Carlo algorithm - the algorithm which will sample our posterior. 

Next, we need to code up our model in Stan.

The first thing to note is that there are two ways to solve our ODEs in Stan


### Method 1: Euler's Method 


Euler's Method is the simplest numerical integration method. Consider an infectious disease model, where susceptible individuals are infected at rate $\beta$ but never recover! 


 $\frac{dS}{dt} = - \beta S \frac{I}{N}$ 
 
 $\frac{dI}{dt} =  \beta S \frac{I}{N}$ 
 
To solve this, the Euler's Method calculates the change in compartment during time interval $t$ and predicts the next state at time $t+1$:

$S_{t+1} = S_t - \beta S_t \frac{I_t}{N}$

$I_{t+1} = I_t + \beta S_t \frac{I_t}{N}$

Assume we have a population $N=100$ and a transmission rate of $ \beta = 1$. The initial conditions are: $I_0 = 1$ and $S_0 = 99$. 

At $t_1$, we can calculate our states as: 

$S_{t1} = 99 - 1 . 99 . \frac{1}{100}  =  98.01$ 


$I_{t1} = 1 + 1 . 99 . \frac{1}{100} = 1.99$

At $t_2$, we can calculate our states as: 

$S_{t1} = 98.01 - 1 . 98.01 . \frac{1.99}{100} = 96.06$ 

$I_{t1} = 1.99 + 1 . 99 . \frac{1.99}{100} = 3.94$

And so on... 


To solver our ODEs in Stan using this method, we can simply use a for loop to solve the equations at each time step and predict the state at the next time step.

This method is simple, but its accuracy depends on the time step used. Smaller time steps will get closer to the exact solution. For instance, when fitting a model over the course of a year, day intervals are likely sufficient. If fitting a model over days, then hours would be a more appropriate interval. A benefit of using simulated data, as we will see, is that we can check that our time step is sufficiently small to obtain an accurate approximation of the solution. Depending on the required level of accuracy, the time step needed to obtain an acceptable approximation may be so small as to be computationally expensive. In this instance, higher order methods are used such as the  [Runge-Kutta Method](#RKM)

So, to see how we code up the SEIQR model in Stan using Euler's Method, go ahead and open up *model1_Euler_V1.stan*, in the *models* folder. 

You will find a data block, a parameters block, a transformed parameters block a model block and a generated quantities block. 

#### Data block

The data block includes the number of data points we have, as well as the number of time steps to run the model over. These two values aren't the same as we don't expect to have observed the transmission of Omega from the very first day of its emergence. To account for this, we seed our model ($I_0$) a few weeks or months before we fit the data to it. We are going to seed Omicron a month before we observe data, this is data we also provide in this block. 

The data block also contains the parameters and initial conditions we aren't estimating, and of course, our observed data. 

#### Parameters block

This contains the parameters we want to estimate. Note the bounds we put on parameters, which must also be positive and for rho must be between 0 and 1. 

#### Transformed parameters block

This is where we estimate the solution to the ODEs at each time step. We also calculate the reported incidence and extract the time points we are going to fit to. 

#### Model block

This contains the model likelihood and priors.

#### Generated quantities block

This contains code to calculate any other quantities that are not needed for the model block. In this instance, we will calculate $R_0$.


Take some time to read over the model and check it makes sense. 


# Simulating data

Before we fit our model to real data, we will use simulated data to check the model. This is useful to check we have no bugs in our code. Also, even though Stan has lots of helpful diagnostics, we can never be completely certain our sampling algorithm has converged on the true posterior distribution. The diagnostics only confirm when it definitely hasn't. Therefore, using simulated data lets us check that the model can recover known posterior estimates, which gives us more confidence when it comes to fitting data. 


## Defining input parameters 
First, lets set the start and end date over which to fit the model, converted into a date format in R. For more detail on working with dates in R, see [here](https://www.stat.berkeley.edu/~s133/dates.html).  


```{r}
start_date =  as.Date.character("01-09-2021", format = "%d-%m-%Y") 
end_date = as.Date.character("23-02-2022", format = "%d-%m-%Y")
all_dates = seq.Date(from = start_date, to = end_date ,  by = "days") # model times 
ts = 1:length(all_dates)
```


Next, we need to estimate the transmission rate 


We are assuming an reproduction number (R0) of 5, as estimated for Delta [1]. We to know now that the Omicron R0 is higher than this, but when Omicron first emerged we knew nothing about it! Therefore, our prior knowledge is based on Delta. 

```{r}
R0 = 5          # reproduction number 
beta = ( R0 * gamma )/ (1-rho) # transmission rate  
rho = 0.2       # reporting probability 
```


```{r}
simulate_data (
  n_pop = 15810388,                
  immunity = 0.562, 
  n_inf = 1,
  sigma = 1/5.1,   
  gamma = 1/2.1,   
  rho = rho,
  beta = beta, 
  ts = ts
)
```



Once we have a vector of each date we are fitting the model, we can find the right index for important events in our model. For instance, this could include the data an intervention was implemented or a day to start vaccinating. In this simple model, we just want to allow for some time before we fit our model output to the data. To account for this, we will run the model for 1 month, before we "collect" data on the incidence. 

```{r}
seed_omicron =  which(all_dates == as.Date.character("01-10-2021", format = "%d-%m-%Y")) 
```
 


Plot all the model states. 

```{r}
for(i in 2:ncol(out.df)) plot(out.df[,i], main = names(initial_state)[(i-1)] )
```


They all look sensible. As an extra check, lets run the model again with R0 = 1. 

**What would we expect the outbreak to look like?**

```{r}

params_check = c(beta=(1 * gamma )/ (1-rho) , sigma, gamma,rho)
model_check = ode(initial_state, ts, SEIQR, params_check)


for(i in 2:ncol(model_check)) plot(model_check[,i], main = names(initial_state)[(i-1)] )
```


As expected, R0 = 1 means that, on average, each infectious person infects just one more person. This means that the epidemic doesn't take off. 


Going back to our simulated epidemic, lets calculate the reported incidence (i.e., the rate that individuals enter the Q compartment) and plot it. Remember, we want to discard the first month as unobserved transmission.   

```{r}
sim_data = data.frame(time = ts,
                      rep_inc = round(rho *out.df$E * sigma))[seed_omicron:length(ts), ]

ggplot(sim_data, aes(x= time , y = rep_inc)) +
  geom_point()

```
Finally, lets save our simulated data. 
```{r}
write.csv(sim_data, paste0(file_path, "data/sim_data.csv"))
```


## References 

- (1) Madhi SA, Kwatra G, Myers JE, et al. Population Immunity and Covid-19 Severity with Omicron Variant in South Africa. N Engl J Med 2022; 386(14): 1314-26.
- (2) Lavezzo E, Franchin E, Ciavarella C, et al. Suppression of a SARS-CoV-2 outbreak in the Italian municipality of Vo’. Nature 2020; 584(7821): 425-9.
- (3) McAloon C, Collins Á, Hunt K, et al. Incubation period of COVID-19: a rapid systematic review and meta-analysis of observational research. BMJ Open 2020; 10(8): e039652.
- (4) Liu, Y. & Rocklov, J. The reproductive number of the Delta variant of SARS-CoV-2 is far higher compared to the ancestral SARS-CoV-2 virus. J Travel Med 28, doi:10.1093/jtm/taab124 (2021).